<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>GOW - Underspire</title>
    <link href="./bootstrap.min.css" rel="stylesheet">
    <style>
        body,
        div {
            margin: 0;
            padding: 0;
            border: 0;
        }

        body {
            background-color: #c7c8c9;
        }

        #underspire-input {
            margin: auto;
            margin-top: 0px;
            font-size: 14px;
            width: 1040px;
        }

        .input-container {
            margin: auto;
            margin-top: 0px;
            font-size: 14px;
            width: 1040px;
            padding-left: 10px;
        }


        #underspire-map {
            margin-left: calc(50vw - 520px);
            margin-top: 10px;
            min-width: 800px;
            min-height: 800px;
        }

        #underspire-info {
            margin: auto;
            margin-top: 20px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #5a5a5a;
            width: 1040px;
            text-align: right;
            font-family: 'Courier New', Courier, monospace;
        }

        #underspire-info .line {
            padding-top: 3px;
        }

        #underspire-map tr,
        #underspire-map td {
            margin: 0;
            padding: 0;
            border: 0;
            text-align: center;
            color: #777676;
            font-size: 12px;
            background-color: #eaebec;
        }

        .cell {
            width: 51px;
            height: 51px;
            display: grid;
            grid-template-columns: 33.33% 33.33% 33.33%;
            grid-template-rows: 33.33% 33.33% 33.33%;
        }

        .cell:hover {
            filter: drop-shadow(2px 5px 10px #333);
        }
        
        .cell-core {
            background-color: #979899;
            font-size: 12px;
            color: #fff;
            cursor: pointer;
            border-radius: 1px;
        }

        .cell-path {
            background-color: transparent;
        }

        .cell-path.up,
        .cell-path.down {
            margin: 0 5.5px;
        }

        .cell-path.left,
        .cell-path.right {
            margin: 5.5px 0;
        }

        .cell.up .cell-path.up,
        .cell.down .cell-path.down,
        .cell.left .cell-path.left,
        .cell.right .cell-path.right {
            background-color: #777879;
        }

        .cell.main {
            background-color: #b0cdd0;
        }

        .cell.up .cell-path.main.up,
        .cell.down .cell-path.main.down,
        .cell.left .cell-path.main.left,
        .cell.right .cell-path.main.right {
            background-color: #25f3fa;
        }

        .cell.none .cell-path,
        .cell.none .cell-core {
            background-color: transparent;
        }

        .label-completed,
        .cell.completed {
            background-color: #38404a!important;
        }
        
        .label-tip {
            padding-left: 6px;
            padding-right: 6px;
            cursor: pointer;
            color: #fff;
        }

        .label-gate,
        .cell.entrance .cell-core,
        .cell.gate .cell-core,
        .cell.gate-up .cell-path.up,
        .cell.gate-down .cell-path.down,
        .cell.gate-left .cell-path.left,
        .cell.gate-right .cell-path.right {
            background-color: #25f3fa !important;
        }

        .label-boss,
        .cell.boss .cell-core {
            background-color: #ff5e00 !important;
        }

        .cell.shop .cell-core {
            /* background-color: #555 !important; */
        }

        .label-guardian,
        .cell.guardian .cell-core {
            background-color: #00f80c !important;
        }
        
        .label-guardian-90,
        .cell.guardian-90 .cell-core {
            background-color: #d3d700;
        }

        .label-trap-90,
        .cell.trap-90 .cell-core {
            background-color: #d12b63;
        }

        #underspire-tool {
            font-size: 9px;
            width: 1040px;
            margin: auto;
            text-align: right;
        }

    </style>
</head>

<body>
    <script src="./jquery-3.6.0.min.js"></script>
    <script src="./bootstrap.bundle.min.js"></script>
    <div id="underspire-input" class="row g-3">
        <div class="col-11">
          <input type="text" class="form-control form-control-sm" placeholder="THE DATA YOU FOUND">
        </div>
        <div class="col-1">
          <button type="submit" class="btn btn-success btn-sm mb-3" style="width: 80px;">go</button>
        </div>
    </div>

	<div class="input-container">
        <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="icb-gate" checked disabled value="option1">
            <label class="form-check-label label-tip label-gate" for="inlineCheckbox1">牢门</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="icb-boss" checked disabled value="option2">
            <label class="form-check-label label-tip label-boss">牢龙</label>
          </div> 
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="icb-shop" checked disabled value="option2">
            <label class="form-check-label label-tip">商人</label>
          </div> 
          <div class="form-check form-check-inline">
            <input class="form-check-input switch-tip" type="checkbox" id="icb-guardian" value="option2">
            <label class="form-check-label label-tip label-guardian" for="icb-guardian">守卫</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input switch-tip" type="checkbox" id="icb-guardian-90" value="option2">
            <label class="form-check-label label-tip label-guardian-90" for="icb-guardian-90">宝藏</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input switch-tip" type="checkbox" id="icb-trap-90" value="option2">
            <label class="form-check-label label-tip label-trap-90" for="icb-trap-90">陷阱</label>
          </div>
          <div class="form-check form-check-inline">

          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input switch-tip" type="checkbox" id="icb-completed" value="option2">
            <label class="form-check-label label-tip label-completed" for="icb-completed">已完成</label>
          </div>
    </div>

    <table id="underspire-map" class="shadow "> </table>
    <div id="underspire-info"></div>
    <div id="underspire-tool">
        <!-- <button id="button-clear" class="btn btn-sm btn-primary">清除标记</button>  -->
    </div>

    <script>
        let fuzzyMode = "fuzzy"; // or "clear"
        let information = "";
        let fuzzies = {};
        let switches = {};

        const CELL_TYPE_ENTRANCE = 0x01;
        const CELL_TYPE_GUARDIAN_2 = 0x02;
        const CELL_TYPE_GUARDIAN_3 = 0x03;
        const CELL_TYPE_GUARDIAN_4 = 0x04;
        const CELL_TYPE_GUARDIAN_5 = 0x05;
        const CELL_TYPE_DRAGON = 0x09;
        const CELL_TYPE_FINAL = 0x0a;
        const CELL_TYPE_SHOP = 0x0b;
        const CELL_TYPE_90_TRAP = 12;
        const CELL_TYPE_90_GUARDIAN = 13;
        const DIRS = [
            { o: 1, row: 1, col: 0, bit: 2, name: "down" }, // down
            { o: 0, row: -1, col: 0, bit: 0, name: "up"}, // up
            { o: 3, row: 0, col: 1, bit: 1, name: "right" },  // right
            { o: 2, row: 0, col: -1, bit: 3, name: "left" },  // left
        ];

        const getCellNum = (row, col) => {
            return row * 100 + col;
        }

        const getCellRC = (num) => {
            return {
                row: (num / 100) | 0,
                col: (num % 100) | 0
            };
        }

        const getCellId = (num) => {
            return `underspire-map-cell-${num}`;
        }

        const getCellDomId = (row, col) => {
            return getCellId(getCellNum(row, col));
        }

        const getCellType = (value) => {
            return (value & 0xF0) >> 4;
        }

        const is = (value, typa) => {
            return getCellType(value) == typa
        }

        const isGuardian = (value) => {
            const t = getCellType(value);
            return t == CELL_TYPE_GUARDIAN_2 ||
                t == CELL_TYPE_GUARDIAN_3 ||
                t == CELL_TYPE_GUARDIAN_4 ||
                t == CELL_TYPE_GUARDIAN_5 ||
				(t > CELL_TYPE_GUARDIAN_5 && t <= 7);
        }

        const hasUp = (value) => {
            return (value & 0b0001) == 0;
        }

        const hasRight = (value) => {
            return (value & 0b0010) == 0;
        }

        const hasDown = (value) => {
            return (value & 0b0100) == 0;
        }

        const hasLeft = (value) => {
            return (value & 0b1000) == 0;
        }

        const hasPath = (value, bit) => {
            return (value & (1 << bit)) == 0;
        }

        const opposite = (dir) => {
            return DIRS[dir.o]
        }

        const hasSwitch = (name) => {
            return (name in switches) && switches[name] == true
        }

        const loadSwitch = () => {
            const str = localStorage.getItem("USSWITCH");
            if (!!str) {
                switches = JSON.parse(str);
                $("#icb-trap-90").attr("checked", hasSwitch("trap"))
                $("#icb-guardian").attr("checked", hasSwitch("guardian"))
                $("#icb-guardian-90").attr("checked", hasSwitch("treasures"))
                
                $("#icb-completed").attr("checked", hasSwitch("completed"))
            }
        }

        const saveSwitch = () => {
            switches = {
                trap: $("#icb-trap-90").is(":checked"),
                guardian: $("#icb-guardian").is(":checked"),
                treasures: $("#icb-guardian-90").is(":checked"),

                completed: $("#icb-completed").is(":checked")
            }
            localStorage.setItem("USSWITCH", JSON.stringify(switches))
        }

        const build = (UnderspireData) => {
            window.$s = UnderspireData
            let cells = 0
            let entrance = null
            const roads = []
            const gates = []
            const bosses = []
            const guardians = []
            const treasures = {}
            const traps = []

            const regions = {}
            const parents = {}
            const completed = {}
            
            const deleted = []
            var allclear = 0;

            
            for (const treasure of UnderspireData.ExtraRooms) {
                treasure.row = (treasure.RoomId / 100 % 20) | 0
                treasure.col = (treasure.RoomId % 20) | 0
                treasures[treasure.RoomId] = treasure;
            }

            const isTreasure = (row, col, value = 0) => {
                const num = row * 100 + col;
                if (!(num in treasures)) {
                    return false;
                }
                const t = treasures[num].TypeId;
                if (t == 3 || t == 5) {
                    return true;
                }
                else {
                    console.log(`(${row + 1}, ${col + 1}): TYPE=${t}`);
                    return false;
                }
            }

            const isTrap =  (row, col, value) => {
                return getCellType(value) == CELL_TYPE_90_TRAP
            }

            const isPotral = (row, col, value) => {
                const rid = row * 100 + col;
                if (!(rid in treasures)) {
                    return false;
                }
                const t = treasures[rid].TypeId;
                if (t == 1) {
                    return true;
                }
                else {
                    return false;
                }
            }

            const isEntrance = (row, col) => {
                return row == entrance.row && col == entrance.col
            }

            const isGate = (row, col) => {
                const found = gates.find((gate) => gate.row == row && gate.col == col)
                return !!found;
            }

            const getGateDir = (row, col) => {
                for (let i = 0; i < 6; i++) {
                    const g = UnderspireData.Gates[i];
                    if (g.Node == getCellNum(row, col)) {
                        return g.Dir;
                    }
                }
                return -1;
            }

            const isConnected = (r1, c1, r2, c2, bit) => {
                if (r1 < 0 || r1 >= 20 ||
                    c1 < 0 || c1 >= 20 ||
                    r2 < 0 || r2 >= 20 ||
                    c2 < 0 || c2 >= 20) {
                    return false;
                }
                const tib = (bit + 2) % 4;
                const v1 = UnderspireData.Map[r1][c1];
                const v2 = UnderspireData.Map[r2][c2];
                return hasPath(v1, bit) && hasPath(v2, tib);
            }

            const getRegion = (row, col) => {
                return regions[getCellNum(row, col)]
            }

            const isCompleted = (row, col) => getCellNum(row, col) in completed

            const buildCell = (row, col, value) => {
                const dir = [];
                if ((value & 0xF) == 0xF) {
                    dir.push("none")
                }
                if (hasUp(value)) {
                    dir.push("up");
                }
                if (hasRight(value)) {
                    dir.push("right");
                }
                if (hasDown(value)) {
                    dir.push("down");
                }
                if (hasLeft(value)) {
                    dir.push("left");
                }
                if (is(value, CELL_TYPE_ENTRANCE)) {
                    dir.push("entrance");
                }
                return `
                <td>
                    <div id="${getCellDomId(row, col)}" class="cell ${dir.join(' ')}">
                        <div></div>
                        <div class="cell-path up"></div>
                        <div></div>
                        <div class="cell-path left"></div>
                        <div class="cell-core">${is(value, CELL_TYPE_ENTRANCE) ? 'E' : ''}</div>
                        <div class="cell-path right"></div>
                        <div></div>
                        <div class="cell-path down"></div>
                        <div></div>
                    </div>
                </td>
            `
            };

            $("#underspire-map").empty(); {
                const tr = ['<td>&nbsp;</td>'];
                for (let col = 0; col < 20; col++) {
                    tr.push(`<td>${col + 1}</td>`);
                }
                tr.push('<td>&nbsp;</td>');
                $("#underspire-map").append(`<tr>${tr}</tr>`);
            }

            for (let row = 0; row < 20; row++) {
                const tr = [`<td>${row + 1}</td>`];
                for (let col = 0; col < 20; col++) {
                    const value = UnderspireData.Map[row][col];
                    tr.push(buildCell(row, col, value));
                }
                tr.push(`<td>${row + 1}</td>`)
                $("#underspire-map").append(`<tr>${tr}</tr>`);
            }
            
            if (1) {
                const tr = ['<td>&nbsp;</td>'];
                for (let col = 0; col < 20; col++) {
                    tr.push(`<td>${col + 1}</td>`);
                }
                tr.push('<td>&nbsp;</td>');
                $("#underspire-map").append(`<tr>${tr}</tr>`);
            }

            for (let row = 0; row < 20; row++) {
                for (let col = 0; col < 20; col++) {
                    const value = UnderspireData.Map[row][col];
                    if (is(value, CELL_TYPE_SHOP)) {
                        $(`#${getCellDomId(row, col)}`).addClass('shop');
                        $(`#${getCellDomId(row, col)} .cell-core`).text('S');
                    }
                    else if (is(value, CELL_TYPE_DRAGON) || is(value, CELL_TYPE_FINAL)) {
                        bosses.push({ row, col });
                        $(`#${getCellDomId(row, col)}`).addClass('boss');
                        $(`#${getCellDomId(row, col)} .cell-core`).text('B');
                    }
                    else if (isGuardian(value) && hasSwitch("guardian")) {
                        $(`#${getCellDomId(row, col)}`).addClass('guardian').addClass("fuzzy");
                        $(`#${getCellDomId(row, col)} .cell-core`).text(` `);
                        guardians.push({row, col});
                    }
                    else if (is(value, CELL_TYPE_ENTRANCE)) {
                        entrance = { row, col, parent: null };
                    }
                    else if (getCellType(value) == 0) {

                    }
                    else if (isTreasure(row, col, value) && hasSwitch("treasures")) {
                        $(`#${getCellDomId(row, col)}`).addClass('guardian-90');
                    }
                    else if (isPotral(row, col, value)) {
                        $(`#${getCellDomId(row, col)} .cell-core`).text(`<>`);
                    }
                    else if (isTrap(row, col, value) && hasSwitch("trap")) {
                        traps.push({ row, col })
                        $(`#${getCellDomId(row, col)}`).addClass('trap-90');
                    }
                    else {
                        // console.log(`${row}:${col}: type=${getCellType(value)}, value=${value.toString(16)}`);
                    }

                    if (value != 0xF) {
                        cells++;
                    }
                }
            }

            for (const key in UnderspireData.Gates) {
                let d = "";
                const num = parseInt(key) + 1;
                const gate = UnderspireData.Gates[key];
                const row = gate.Node / 100 | 0;
                const col = gate.Node % 100;

                for (const dir of DIRS) {
                    if (dir.bit == gate.Dir) {
                        d = dir.name;
                    }
                }
                if (d == "") {
                    console.error(`${gate.Node} ${gate.Dir}`);
                }
                
                gates.push({ row, col, num, dir: d });
                $(`#underspire-map-cell-${gate.Node}`).addClass(`gate-${d}`).addClass('gate');
                $(`#underspire-map-cell-${gate.Node} .cell-core`).text(num);
            }

            for (const complete of UnderspireData.Completed) {
                const row = ((complete / 100) % 20) | 0
                const col = (complete % 20) | 0
                completed[getCellNum(row, col)] = { row, col }
            }
            
            if (hasSwitch("completed")) {
                for (const num in completed) {
                    const complete = completed[num]
                    const { row, col } = complete
                    $(`#${getCellDomId(row, col)}`).addClass("completed");
                }
            }
            else {
                $(`#${getCellDomId(entrance.row, entrance.col)}`).addClass("completed");
            }
                    
            // console.log(`entrance`, entrance);
            // console.log(`gates`, gates);
            // console.log(`bosses`, bosses);
            // console.log(`completed`, completed);

            const dive = (row, col, distance, region) => {
                regions[getCellNum(row, col)] = region
                if (isGate(row, col)) {
                    region++
                }
                for (const dir of DIRS) {
                    const rew = row + dir.row
                    const cel = col + dir.col
                    const nem = getCellNum(rew, cel)
                    if (isConnected(row, col, rew, cel, dir.bit) && !(nem in parents)) {
                        parents[nem] = { row, col, dir }
                        dive(rew, cel, distance + 1, region)
                    }
                }
            }


            let main$ = 0
            let guardian$ = 0
            let treasure$ = 0
            let trap$ = 0
            const detected = { }

            if (hasSwitch(`completed`)) {
                for (const room in completed) {
                    detected[room] = true
                }
            }
            else {
                detected[getCellNum(entrance.row, entrance.col)] = true
            }

            const isUnseen = (row, col) => {
                return !(getCellNum(row, col) in detected)
            }

            parents[getCellNum(entrance.row, entrance.col)] = { row: -1, col: -1 }
            
            dive(entrance.row, entrance.col, 0, 1)

            bosses.forEach(boss => {
                let node = boss
                const region = getRegion(node.row, node.col)
                $(`#${getCellDomId(node.row, node.col)} .cell-core`).text(`${region == 7 ? 'F' : region}`)

                while (isUnseen(node.row, node.col) && node.row >= 0) {
                    const num = getCellNum(node.row, node.col)
                    const pant = parents[num]
                    const pum = getCellNum(pant.row, pant.col)
                    $(`#${getCellDomId(node.row, node.col)}`).addClass(`main`);
                    if (pant.row >= 0) {
                        $(`#${getCellDomId(pant.row, pant.col)} .cell-path.${pant.dir.name}`).addClass(`main`)
                        $(`#${getCellDomId(node.row, node.col)} .cell-path.${opposite(pant.dir).name}`).addClass(`main`)
                    }
                    node = pant
                }
            })

            bosses.forEach(boss => {
                let { row, col } = boss
                while (isUnseen(row, col) && row >= 0) {
                    main$ ++
                    const num = getCellNum(row, col)
                    const pnt = parents[num]
                    detected[num] = true
                    row = pnt.row
                    col = pnt.col
                }
            })

            guardians.forEach(guardian => {
                let { row, col } = guardian
                while (isUnseen(row, col) && row >= 0) {
                    guardian$ ++
                    const num = getCellNum(row, col)
                    const pnt = parents[num]
                    detected[num] = true
                    row = pnt.row
                    col = pnt.col
                }
            })

            if (hasSwitch("treasures")) {
                for (const num in treasures) {
                    const treasure = treasures[num]
                    let { row, col } = treasure
                    while (isUnseen(row, col) && row >= 0) {
                        treasure$ ++
                        const num = getCellNum(row, col)
                        const pnt = parents[num]
                        detected[num] = true
                        row = pnt.row
                        col = pnt.col
                    }
                }
            }

            traps.forEach(trap => {
                let { row, col } = trap
                while (isUnseen(row, col) && row >= 0) {
                    trap$ ++
                    const num = getCellNum(row, col)
                    const pnt = parents[num]
                    detected[num] = true
                    row = pnt.row
                    col = pnt.col
                }
            })

            // console.log(`main$ ${main$}`)
            // console.log(`guardian$ ${guardian$}`)
            // console.log(`treasure$ ${treasure$}`)
            // console.log(`trap$ ${trap$}`)
            // window.$pnt = parents

            $(`#underspire-info`).html(`
                <div class="line"> 牢龙全清还需约：${main$}</div>
                <div class="line"> 守卫全清还需约：${guardian$}</div>
                <div class="line"> 宝藏全清还需约：${treasure$}</div>
                <div class="line"> 陷阱全清还需约：${trap$}</div>
                <div class="line">     共计约：${main$ + guardian$ + treasure$ + trap$}</div>
            `)
            
            //information = `7龙、箱子全清：${allclear}；迷宫房间总数：${cells}； 已完成：${UnderspireData.Completed.length}`;
            
        }

        $("#underspire-input button").click(() => {
            try {
                const content = $("#underspire-input input").val().replace(/^[^{]*{/, "{");
                const response = JSON.parse(content);
                if ('result' in response && 'Info' in response.result) {
                    build(response.result.Info.UnderspireData);
                    saveMap(JSON.stringify(response.result.Info.UnderspireData));
                }
            }
            catch(e) {

            }
        })
        
        $("#button-clear").click(() => {
            $(".cell.fuzzy").removeClass("fuzzy");
            fuzzies = {};
            localStorage.setItem("USFUZZY", JSON.stringify(fuzzies));
            showInformation();
        });

        const saveMap = (str) => {
            localStorage.setItem("USMAP", str);
        }

        const loadMap = () => {
            const str = localStorage.getItem("USMAP");
            if (!!str) {
                build(JSON.parse(str));
            }
        }
        
        $(`.switch-tip`).change(() => {
            saveSwitch() 
            loadMap()
        });

        loadSwitch();
        loadMap();
    </script>



</body>