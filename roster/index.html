<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>GOW - Roster</title>
    <link href="./bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-size: 12px;
            text-align: center;
            background-color: #151a1a;
        }

        #header {
            height: 50px;
            background-color: #001818;
        }

        #header-content,
        #footer-content {
            margin: 0 auto;
            width: 1800px;
        }

        #content-input {
            margin-top: 10px;
            height: 30px;
            width: 120px;
        }

        #guild-select {
            width: 300px;
            margin: auto;
            text-align: center;
            font-size: 16px;
            cursor: pointer;
        }

        #content-submit {
            height: 30px;
            margin-top: 10px;
            margin-left: 4px;
        }

        #main-content {
            padding-top: 20px;
            padding-bottom: 30px;
            margin: 10px auto;
            width: 1800px!important;
            background-color: #144f4f;
            border-radius: 4px;
        }

        #guild-title {
            font-family: 'Courier New', Courier, monospace;
            color: #ccc;
            text-align: center;
            font-size: 16px;
            padding: 10px 0 30px 0;
            font-weight: bolder;
        }

        #guild-score {
            font-family: 'Courier New', Courier, monospace;
            color: #ccc;
            font-size: 14px;
        }

        #guild-score tr:hover,
        #guild-score tr:active {
            background-color: #1d6e6e;
        }

        #guild-score th,
        #guild-score td {
            width: 300px;
            text-align: center;
        }

        #guild-score th.orderable {
            text-decoration: underline;
            cursor: pointer;
        }

        #guild-score .index {
            width: 100px;
        }

        #guild-score .name {
            text-align: center;
        }
        
    </style>

</head>

<body>
    <!-- 
    <script src="https://unpkg.com/vue"></script>
    <script src="https://unpkg.com/http-vue-loader"></script> 
-->
    <script src="./jquery-3.6.0.min.js"></script>
    <script src="./bootstrap.bundle.min.js"></script>
    <script src="./notify.js"></script>
    <script src="./FileSaver.min.js"></script>
    <script src="../wogapi.js"></script>

    <div id="header">
        <div id="header-content">
            <div style="display: flex; float: left;">
                <div class="tool-line" style="padding: 10px 0;">
                    <input id="input-gwday" class="form-control form-control-sm" type="text" placeholder="会战日期">
                </div>
                <div class="tool-line" style="padding: 10px;">
                    <input id="input-guild-id" class="form-control form-control-sm" type="text" placeholder="工会ID">
                </div>
                <div class="tool-line" style="padding: 10px;">
                    <input id="input-guild-name" class="form-control form-control-sm" type="text" placeholder="工会名">
                </div>
                <div class="tool-line" style="padding: 10px;">
                    <button id="button-guild-add" type="button" class="float-end btn btn-sm btn-success">添加</button>
                </div>
            </div>
            <div style="display: flex; float: right;">
                <div class="tool-line" style="padding: 10px;">
                    <button id="button-guild-remove" type="button" class="float-end btn btn-sm btn-danger">移除工会</button>
                    <button id="button-guild-sync" type="button" class="float-end btn btn-sm btn-warning" style="margin-right: 10px">同步数据</button>
                </div>
            </div>
            <div id="guild-select">
                <div class="tool-line" style="padding: 10px;">
                    <select id="select-guild" class="form-select form-select-sm mb-3" aria-label=".form-select-sm"> </select>
                </div>
            </div>
        </div>
    </div>
    <div id="main-content">
        <div class="row">
            <div id="guild-title"></div>
        </div>
        <table id="guild-score">
            <thead>
                <tr>
                    <th class="index">#</th>
                    <th class="name"></th>
                    <th class="orderable" order="-1">总分</th>
                    <th class="orderable" order="0">DAY 1</th>
                    <th class="orderable" order="1">DAY 2</th>
                    <th class="orderable" order="2">DAY 3</th>
                    <th class="orderable" order="3">DAY 4</th>
                </tr>
            </thead>
            <tbody>

            </tbody>
        </table>
    </div>

    
    <div id="footer-content">
        <div style="display: flex; float: left;">
            <div class="tool-line" style="padding: 10px 0 10px 0;">
                <input id="input-import" class="form-control form-control-sm" type="text" placeholder="JSON">
            </div>
            <div class="tool-line" style="padding: 10px;">
                <button id="button-import" type="button" class="float-end btn btn-sm btn-warning" style="margin: 0 10px;">导入 JSON</button>
            </div>
            <div class="tool-line" style="padding: 10px;">
                <button id="button-export-json" type="button" class="float-end btn btn-sm btn-primary" style="margin: 0 10px;">导出 JSON</button>
            </div>
            <div class="tool-line" style="padding: 10px;">
                <button id="button-export-csv" type="button" class="float-end btn btn-sm btn-primary">导出 CSV </button>
            </div>
        </div>
    </div>

    <script>

        let GWDAY = `2026/01/08`
        let conf = { }
        let rosters = { }
        let orderby = ''

        const LoadGWDAY = () => {
            GWDAY = $wog.$get(`GWDAY`) || `2026/01/08`
            $(`#input-gwday`).val(GWDAY)
        }

        const SaveGWDAY = () => {
            GWDAY = $(`#input-gwday`).val()
            $wog.$get(`GWDAY`, GWDAY)
        }

        const GetGWDay = () => {
            const base = new Date(`${GWDAY} 15:00:00 GMT+0800`)
            const now = new Date()
            const day = ((now.getTime() - base.getTime()) / (24 * 3600 * 1000)) | 0
            return Math.min(day, 3)
        }

        const TICK = (tick) => {
            const at = new Date()
            at.setTime(tick)
            return tick ? at.toLocaleString() : ``
        }

        const LoadRosters = () => {
            $wog.loadPlayer()
            conf = $wog.$get(`KEEP_CONFIG`) || {}
            
            if (!$wog.player.username || !$wog.player.password || !conf.eventid) {
                $.notify(`加载玩家信息失败`, {className: 'error',  position: "top-left" })
            }
            else {
                $.notify(`已加载 ${$wog.player.usercode} @ ${conf.eventid}`, {className: 'success',  position: "top" })
            }

            rosters = $wog.$get(`ROSTERS`) || { }
        }

        const SaveRosters = () => {
            $wog.$set(`ROSTERS`, rosters)
        }

        const LoadGuildRoster = (id) => {
            const roster = (id in rosters) ? rosters[id] : { }
            return (roster.eventid === conf.eventid) ? roster : { }
        }

        const SaveGuildRoster = (id, name, scores) => {
            
            const exists = LoadGuildRoster(id)

            const getDayScore = (name, day) => {
                if (!exists.scores) {
                    return 0
                }
                const g = exists.scores.find(g => g.Name == name)
                if (!g || !g.WarResults) {
                    return 0
                }
                return g.WarResults[day].S || 0
            }

            const day = GetGWDay()
            
            const roster = {
                id, 
                day,
                name,
                scores,
                eventid: conf.eventid,
                at: new Date().getTime()
            }

            roster.ticks = exists.ticks || [0, 0, 0, 0]
            roster.ticks[day] = roster.at
            
            for (const guy of roster.scores) {
                let s = guy.ScoreCurrent
                for (let d = 0; d <= day - 1; d++) {
                    guy.WarResults[d].S = getDayScore(guy.Name, d)
                    s = s - (guy.WarResults[d].S || 0)
                }
                guy.WarResults[day].S = s
            }

            rosters[id] = roster

            SaveRosters()

            return roster
        }

        const BuildGuildList = () => {
            $(`#select-guild option`).remove()
            for (const id in rosters) {
                $(`#select-guild`).append($('<option>', {
                    value: id,
                    text: rosters[id].name
                }));
            }
        }

        const Render = (roster) => {
            if (!roster) {
                return
            }

            const Cell = (guy, day) => {
                const d = guy.WarResults[day]
                let c = ''
                if (d.S) {
                    c = `${d.S < 1000 ? '0' : ''}${d.S}  ・  `
                }
                if (d.S || d.W || d.L) {
                    c = c + `${d.W} / ${d.L}`
                }
                return c
            }

            $(`#guild-title`).text(`${roster.name}  ・  ${TICK(roster.at)}` )

            let i = 1
            const scores = roster.scores.sort((x, y) => {
                orderby = parseInt(orderby)
                if (orderby >= 0 && orderby <= 3) {
                    const p = x.WarResults[orderby]
                    const q = y.WarResults[orderby]
                    if (p.W > q.W) return -1
                    if (p.W < q.W) return 1
                    return (q.S || 0) - (p.S ||0)
                }
                else {
                    return y.ScoreCurrent - x.ScoreCurrent
                }
            })
            $(`#guild-score tbody tr`).remove()
            for (const guy of scores) {
                $(`#guild-score tbody`).append(`
                    <tr>
                        <td class="index">${i++}</td>
                        <td class="name">${guy.Name}</td>
                        <td>${guy.ScoreCurrent}</td>
                        <td>${Cell(guy, 0)}</td>
                        <td>${Cell(guy, 1)}</td>
                        <td>${Cell(guy, 2)}</td>
                        <td>${Cell(guy, 3)}</td>
                    </tr>
                `)
            }

            let total = {
                Name: "TOTAL",
                ScoreCurrent: 0,
                WarResults: [
                    { S: 0, W: 0, L: 0 },
                    { S: 0, W: 0, L: 0 },
                    { S: 0, W: 0, L: 0 },
                    { S: 0, W: 0, L: 0 }
                ]
            }
            for (const guy of scores) {
                total.ScoreCurrent += guy.ScoreCurrent
                for (let d = 0; d < 4; d++) {
                    total.WarResults[d].S += guy.WarResults[d].S || 0 
                    total.WarResults[d].W += guy.WarResults[d].W 
                    total.WarResults[d].L += guy.WarResults[d].L
                }
            }
            $(`#guild-score tbody`).append(`
                <tr>
                    <td class="index"></td>
                    <td class="name">&nbsp;</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
            `)
            $(`#guild-score tbody`).append(`
                <tr>
                    <td class="index">TOTAL</td>
                    <td class="name">&nbsp;</td>
                    <td>${total.ScoreCurrent}</td>
                    <td>${Cell(total, 0)}</td>
                    <td>${Cell(total, 1)}</td>
                    <td>${Cell(total, 2)}</td>
                    <td>${Cell(total, 3)}</td>
                </tr>
            `)
            $(`#guild-score tbody`).append(`
                <tr>
                    <td class="index"></td>
                    <td class="name"></td>
                    <td></td>
                    <td>${TICK(roster.ticks[0] || 0)}</td>
                    <td>${TICK(roster.ticks[1] || 0)}</td>
                    <td>${TICK(roster.ticks[2] || 0)}</td>
                    <td>${TICK(roster.ticks[3] || 0)}</td>
                </tr>
            `)

            window.$roster = roster
            $.notify(`${roster.name}`, {className: 'success',  position: "top-left" })
        }

        const Go = () => {
            let gid = $(`#select-guild`).val()
            if (!gid) {
                for (const id in rosters) {
                    $(`#select-guild`).val(id)
                    gid = id
                    break
                }
            }
            if (gid) {
                const roster = LoadGuildRoster(gid)
                Render(roster)
            }
        }

        $(`#button-guild-add`).click(() => {
            SaveGWDAY()
            
            const id = $(`#input-guild-id`).val()
            const name = $(`#input-guild-name`).val()
            if (id in rosters) {
                rosters.name = name
            }
            else {
                rosters[id] = { id, name }
                BuildGuildList()
            }
        })

        $(`#button-guild-remove`).click(() => {
            SaveGWDAY()

            const id = $(`#select-guild`).val()
            if (id in rosters) {
                
                delete rosters[id]

                SaveRosters()

                BuildGuildList()

            }
            $.notify(`移除 ${name}`, {className: 'success',  position: "top-left" })
        })
        
        let syncing = false;

        $(`#button-guild-sync`).click(async () => {
            if (syncing) {
                return
            }

            syncing = true
            $(`#button-guild-sync`).text('正在同步')
            try {
                SaveGWDAY()

                for (const id in rosters) {
                    const guild = rosters[id]
                    const guys = await $wog.GetGuildRoster(guild.id, $wog.$get("KEEP_CONFIG").eventid || 5378)
                    if (!guys || !(length in guys)) {
                        $.notify(`查询 ${guild.name} 失败`, {className: 'error',  position: "top-left" })
                        break
                    }
                    else {
                        $.notify(`已同步 ${guild.name}`, {className: 'success',  position: "top-left" })
                        SaveGuildRoster(guild.id, guild.name, guys)
                    }
                }
                
                Go()
            }
            finally {
                $(`#button-guild-sync`).text('同步数据')
                syncing = false
            }
        })

        $(`#guild-score .orderable`).click(e => {
            orderby = $(e.currentTarget).attr(`order`) || ``
            Go()
        })

        $(`#select-guild`).change(Go)

        $(`#button-export-json`).click(() => {
            const blob = new Blob([JSON.stringify(rosters, null, 2)], {type: "text/plain;charset=utf-8"})
            saveAs(blob, `WOG-Rosters-${GWDAY.replace(/\//g, '-')}.json`)
        })

        $(`#button-export-csv`).click(() => {
            let s = ``
            for (const id in rosters) {
                const guild = rosters[id]
                if (!guild.at) {
                    continue
                }
                let i = 1
                s += `${guild.name}, ${GWDAY}, ${TICK(guild.at)} ,,\r\n`
                s += `#, name, Last, Current, DAY 1, Win, Lose, DAY 2, Win, Lose, DAY 3, Win, Lose, DAY 4, Win, Lose, ,,\r\n`
                for (const guy of guild.scores) {
                    s += `${i++}, ${guy.Name.replace(/,/g, '')}, ${guy.ScoreLast}, ${guy.ScoreCurrent}, `
                    for (let d = 0; d < 4; d++) {
                        s += `${guy.WarResults[d].S || 0}, ${guy.WarResults[d].W}, ${guy.WarResults[d].L}, `
                    }
                    s += `,\r\n`
                }
                s += `,,\r\n`
                s += `,,\r\n`
            }
            const blob = new Blob([s], {type: "text/plain;charset=utf-8"})
            saveAs(blob, `WOG-Rosters-${GWDAY.replace(/\//g, '-')}.csv`)

        })

        $(`#button-import`).click(() => {
            const content = $(`#input-import`).val()
            try {
                rosters = JSON.parse(content)
                SaveRosters()
                $.notify(`导入成功`, {className: 'success',  position: "top" })

                BuildGuildList()
                Go()
            }
            catch {
                $.notify(`导入失败`, {className: 'error',  position: "top" })
            }
        })

        LoadGWDAY()

        LoadRosters()

        BuildGuildList()

        Go()

    </script>



</body>
